import rasterio
from rasterio.merge import merge
from rasterio.plot import show
import glob
import os

# Set your input folder and output mosaic file
input_folder = "path_to_your_folder"
output_mosaic = "mosaic.tif"

# Get all .bil raster files
raster_files = glob.glob(os.path.join(input_folder, "*.bil"))

# Open files using rasterio and keep them in memory-efficient mode
src_files_to_mosaic = [rasterio.open(raster) for raster in raster_files]

# Merge rasters
mosaic, out_transform = merge(src_files_to_mosaic)

# Get metadata from one of the source files
out_meta = src_files_to_mosaic[0].meta.copy()
out_meta.update({
    "driver": "GTiff",
    "height": mosaic.shape[1],
    "width": mosaic.shape[2],
    "transform": out_transform
})

# Write output file
with rasterio.open(output_mosaic, "w", **out_meta) as dest:
    dest.write(mosaic)

# Close all source files
for src in src_files_to_mosaic:
    src.close()

print(f"Mosaic created: {output_mosaic}")
